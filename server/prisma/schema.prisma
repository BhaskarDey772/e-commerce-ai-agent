generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id        String   @id @default(uuid())
  guestId   String?  @unique // Guest ID from cookies
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversations Conversation[]

  @@index([createdAt])
  @@index([guestId])
}

model Conversation {
  id        String   @id @default(uuid())
  sessionId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session  Session?  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([sessionId])
  @@index([sessionId, createdAt])
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  sender         MessageSender
  content        String        @db.Text
  createdAt      DateTime      @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([conversationId])
}

model KnowledgeBase {
  id        String                      @id @default(uuid())
  source    String // "product" | "policy"
  sourceId  String?
  title     String?
  content   String
  embedding Unsupported("vector(1536)")
  createdAt DateTime                    @default(now())

  @@index([source])
}

model Product {
  id              String                       @id @default(uuid())
  uniqId          String                       @unique
  pid             String?
  productName     String                       @db.Text
  productUrl      String?                      @db.Text
  category        String                       @db.Text
  categoryTree    String?                      @db.Text
  retailPrice     Float?
  discountedPrice Float?
  image           String?                      @db.Text
  images          String?                      @db.Text // JSON array of image URLs
  description     String?                      @db.Text
  productRating   Float?
  overallRating   Float?
  brand           String?
  specifications  String?                      @db.Text // JSON string
  isFKAdvantage   Boolean                      @default(false)
  crawlTimestamp  DateTime?
  embedding       Unsupported("vector(1536)")?
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt

  @@index([category])
  @@index([brand])
  @@index([discountedPrice])
  @@index([productRating])
  @@index([createdAt])
}

enum MessageSender {
  USER
  AI
}
